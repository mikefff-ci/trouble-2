version: 2.1

workflows:
  testing:
    jobs:
      - testing

jobs:
  testing:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run: netstat -ltpa
      - run: |
          echo $CIRCLE_PR_NUMBER
          if [ ! -z "$CIRCLE_PR_NUMBER" ] ; then
            # Get base ref from Github API
            resp=$(curl -Ls "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/pulls/${CIRCLE_PR_NUMBER}")
            head_ref=$(jq -r .base.ref \<<< $resp)

            # Create new directory and clone again
            mkdir ../clone
            cd ../clone
            git clone "$CIRCLE_REPOSITORY_URL" .
            git fetch --all
            git fetch --force origin "pull/${CIRCLE_PR_NUMBER}/head:remotes/origin/pull/${CIRCLE_PR_NUMBER}"
            CHANGED=$(git --no-pager diff --name-only remotes/origin/${CIRCLE_BRANCH}..remotes/origin/${head_ref})
          else
            mkdir ../clone
            cd ../clone
            git clone "$CIRCLE_REPOSITORY_URL" .
            git fetch --all
            CHANGED=$(git --no-pager diff --name-only remotes/origin/${CIRCLE_BRANCH}..remotes/origin/test-rev-list)
          fi
          
          echo "\n==============="
          echo $CHANGED
